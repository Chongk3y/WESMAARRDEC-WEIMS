{% extends 'equipments/base.html' %}
{% load humanize %}
{% block title %}Equipment List{% endblock %}
{% block content %}
{% if messages %}
  {% for message in messages %}
    <div class="alert alert-{{ message.tags }}">{{ message }}</div>
  {% endfor %}
{% endif %}

<div class="m-4">
<div class="d-flex justify-content-between align-items-center mb-3">
  <h5 class="fw-semibold mb-0">Equipment Management</h5>
</div>

<!-- Toolbar -->
<div class="row gy-2 gx-2 align-items-center">

  <!-- SEARCH BAR -->
  <div class="col-md-3">
    <input type="text" id="tableSearch" class="form-control form-control-sm" placeholder="Search equipment...">
  </div>

  <!-- BULK ACTIONS GROUP -->
  {% if is_admin or is_encoder %}
  <div class="col-12 col-md-auto">
    <form id="bulkUpdateForm" method="post" action="{% url 'equipments:bulk_update' %}">
      {% csrf_token %}
      <div class="row gy-2 gx-2 align-items-center">
        
        <!-- Status Select -->
        <div class="col-12 col-sm-auto">
          <select name="status_id" class="form-select form-select-sm w-100" style="min-width: 140px;">
            <option value="">Change Status...</option>
            {% for status in statuses %}
              {% if status.name != 'Lost' and status.name != 'Damaged' %}
                <option value="{{ status.id }}">{{ status.name }}</option>
              {% endif %}
            {% endfor %}
          </select>
        </div>
        
        <!-- Category Select -->
        <div class="col-12 col-sm-auto">
          <select name="category_id" class="form-select form-select-sm w-100" style="min-width: 140px;">
            <option value="">Change Category...</option>
            {% for category in categories %}
              <option value="{{ category.id }}">{{ category.name }}</option>
            {% endfor %}
          </select>
        </div>
        
        <!-- Apply Button -->
        <div class="col-12 col-sm-auto">
          <button type="submit" class="btn btn-outline-primary btn-sm w-100 w-sm-auto" disabled
                  title="Apply status or category changes to multiple selected equipment at once">
            Apply to Selected
          </button>
        </div>

        <!-- Bulk Archive Button -->
        <div class="col-12 col-sm-auto">
          <button type="button" id="bulkArchiveBtn" class="btn btn-outline-warning btn-sm w-100 w-sm-auto" disabled
                  title="Archive multiple selected equipment to move them to archived status">
            <i class="bi bi-archive text-muted"></i> Archive Selected
          </button>
        </div>

        <!-- Bulk Delete Button - Admin/Superadmin Only -->
        {% if is_admin or is_superadmin %}
        <div class="col-12 col-sm-auto">
          <button type="button" id="bulkDeleteBtn" class="btn btn-outline-danger btn-sm w-100 w-sm-auto" disabled
                  title="Permanently delete multiple selected equipment from the system">
            <i class="bi bi-trash text-muted"></i> Delete Selected
          </button>
        </div>
        {% endif %}

      </div>
    </form>
  </div>
  {% endif %}

  <!-- FILTER & ORDERING TOOLS -->
  <div class="col-md-auto d-flex flex-wrap gap-2">
    <button type="button" class="btn btn-outline-dark btn-sm" data-bs-toggle="modal" data-bs-target="#advancedFilterModal"
            title="Click to open advanced filtering options. Search equipment by specific criteria like status, category, date ranges, and more">
      <i class="bi bi-funnel"></i> Filter
    </button>

    <button id="toggleOrderBtn" class="btn btn-outline-secondary btn-sm"
            data-bs-toggle="tooltip" data-bs-placement="top" 
            title="Click to switch between showing newest equipment first or oldest equipment first in the table">
      Show Oldest First
    </button>

    <div class="dropdown">
      <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" id="columnVisibilityDropdown" data-bs-toggle="dropdown" aria-expanded="false"
              title="Click to show or hide table columns. Check/uncheck items to customize which information is displayed in the equipment table">
        Columns
      </button>
      <ul class="dropdown-menu" id="columnVisibilityMenu" aria-labelledby="columnVisibilityDropdown">
        <!-- JS Populated -->
      </ul>
    </div>
  </div>

  {% if is_admin or is_encoder %}
  <!-- ADMIN/ENCODER TOOLS -->
  <div class="col-md-auto d-flex flex-wrap gap-2">
    <form action="{% url 'equipments:import_excel' %}" method="post" enctype="multipart/form-data" id="importExcelForm">
      {% csrf_token %}
      <input type="file" name="excel_file" accept=".xlsx,.xls" style="display:none;" id="importExcelInput" onchange="this.form.submit()">
      <button type="button" class="btn btn-outline-primary btn-sm" onclick="document.getElementById('importExcelInput').click();"
              data-bs-toggle="tooltip" data-bs-placement="top" 
              title="Click to select an Excel file (.xlsx or .xls) to import equipment data. File will be uploaded and processed automatically">
        <i class="bi bi-upload"></i> Import Excel
      </button>
    </form>

    <a href="{% url 'equipments:export_excel' %}" class="btn btn-outline-info btn-sm"
       data-bs-toggle="tooltip" data-bs-placement="top" 
       title="Download all equipment data as an Excel file. Includes currently filtered results if any filters are applied">
      <i class="bi bi-file-earmark-excel"></i> Export Excel
    </a>

    <a href="{% url 'equipments:add' %}" class="btn btn-outline-success btn-sm"
       data-bs-toggle="tooltip" data-bs-placement="top" 
       title="Click to open the form for adding new equipment to the system">
      <i class="bi bi-plus-circle"></i> Add
    </a>
  </div>
  {% endif %}
</div>


  <!-- Equipment Table Card -->
  <div class="card shadow-sm border-0 mt-4">
    <div class="card-header bg-success-subtle text-success-emphasis  d-flex justify-content-between align-items-center">
      <h6 class="mb-0 d-flex align-items-center gap-2">
        <i class="bi bi-clipboard-data"></i> Equipment Table
      </h6>
      <span class="badge bg-success text-white">{{ total_equipments }} Items</span>
    </div>

    <div class="card-body p-3">
      <div class="table-responsive">
        <table id="equipmentTable" class="table table-hover table-striped table-bordered align-middle text-nowrap small rounded">
          <thead class="table-success">
            <tr class="align-middle text-center">
              <th><input type="checkbox" id="selectAll" title="Select all"></th>
              <th style="display:none;"></th> <!-- Hidden ID column -->
              <th>Image</th>
              <th>Property #</th>
              <th>Name</th>
              <th>Description</th>
              <th>PO Number</th>
              <th>Amount</th>
              <th>End User</th>
              <th>Category</th>
              <th>Status</th>
              <th>Actions</th>
              <th>Fund Source</th>
              <th>Supplier</th>
              <th>Assigned To</th>
              <th>Deployment Location</th>
              <th>Current Location</th>
              <th>PO Date</th>
              <th>Project Name</th>
            </tr>
          </thead>
          <tbody>
            <!-- Dynamic data rows -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<!-- Place this at the end of your file, outside any <table> or <form> -->
<div class="modal fade" id="returnModal" tabindex="-1" aria-labelledby="returnModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="returnForm" method="post" enctype="multipart/form-data" action="{% url 'equipments:return_equipment' %}">
      {% csrf_token %}
      <input type="hidden" name="equipment_id" id="returnEquipmentId">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="returnModalLabel">Return Equipment</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <!-- Equipment Information Display -->
          <div class="alert alert-info mb-3">
            <h6 class="mb-2"><i class="bi bi-info-circle me-2"></i>Equipment Details</h6>
            <div class="row">
              <div class="col-sm-6">
                <strong>Property Number:</strong><br>
                <span id="returnEquipmentProperty" class="text-primary">N/A</span>
              </div>
              <div class="col-sm-6">
                <strong>Equipment Name:</strong><br>
                <span id="returnEquipmentName" class="text-primary">N/A</span>
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label for="returnDocument" class="form-label">Upload Return Documents</label>
            <input type="file" class="form-control" id="returnDocument" name="return_document" accept=".pdf,image/*" multiple required>
            <div class="form-text">You can select multiple files. Supported formats: PDF, Images</div>
            <div id="selectedFiles" class="mt-2" style="display: none;">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <small class="text-muted fw-medium">Selected files:</small>
                <button type="button" class="btn btn-sm btn-outline-secondary clear-all-files" title="Clear all files">
                  <i class="bi bi-trash3"></i> Clear All
                </button>
              </div>
              <div class="border rounded p-2" style="max-height: 200px; overflow-y: auto;">
                <ul id="fileList" class="list-unstyled mb-0"></ul>
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label for="returnRemarks" class="form-label">Remarks</label>
            <textarea class="form-control" id="returnRemarks" name="return_remarks" rows="2"></textarea>
          </div>
          <div class="mb-3">
            <label for="returnedBy" class="form-label">Returned By</label>
            <input type="text" class="form-control" id="returnedBy" name="returned_by" required>
          </div>
          <div class="mb-3">
            <label for="received_by" class="form-label">Received By</label>
            <input type="text" class="form-control" id="returnedTo" name="received_by" required>
          </div>
          <div class="mb-3">
            <label for="returnCondition" class="form-label">Condition Upon Return</label>
            <select class="form-select" id="returnCondition" name="return_condition">
              <option value="">Select condition</option>
              <option value="Good">Good</option>
              <option value="Needs Repair">Needs Repair</option>
              <option value="Damaged">Damaged</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="returnType" class="form-label">Return Type</label>
            <select class="form-select" id="returnType" name="return_type">
              <option value="">Select type</option>
              <option value="Return">Return</option>
              <option value="Retirement">Retirement</option>
              <option value="Disposal">Disposal</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Submit Return</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>  
      </div>
    </form>
  </div>
</div>

<!-- Equipment Details Modal -->
<div class="modal fade" id="equipmentModal" tabindex="-1" aria-labelledby="equipmentModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0 pb-1">
        <h5 class="modal-title fw-semibold" id="equipmentModalLabel">Equipment Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body py-1 px-3" style="max-height: 75vh; overflow-y: auto;">
        <div class="row mb-3">
          <div class="col-md-4 text-center">
            <img id="modalImage" src="" class="img-fluid rounded shadow-sm" style="width: 120px; height: 120px; object-fit: cover;" alt="Equipment Image">
            <div class="text-center mt-2">
              <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#historyModal">
                <i class="bi bi-clock-history"></i> View Edit History
              </button>
            </div>
          </div>
          
          <div class="col-md-8">
            <div class="row g-2">
              <div class="col-sm-6"><small class="text-muted">Property #</small><div id="modalPropertyNum" class="fw-medium"></div></div>
              <div class="col-sm-6"><small class="text-muted">Name</small><div id="modalName" class="fw-medium"></div></div>
              <div class="col-sm-12"><small class="text-muted">Description</small><div id="modalDesc" class="fw-normal text-wrap"></div></div>
              <div class="col-sm-12"><small class="text-muted">Additional Info</small><div id="modalAddInfo" class="text-muted"></div></div>
              <div class="col-sm-6"><small class="text-muted">Amount</small><div id="modalAmount" class="fw-medium text-success"></div></div>
              <div class="col-sm-6"><small class="text-muted">Category</small><div id="modalCategory"></div></div>
              <div class="col-sm-6"><small class="text-muted">Status</small><div id="modalStatus"></div></div>
              <div class="col-sm-12" id="modalDamageReasonRow" style="display: none;"><small class="text-muted">Damage Reason</small><div id="modalDamageReason" class="fw-normal text-wrap text-danger"></div></div>
              <div class="col-sm-12" id="modalLostRemarksRow" style="display: none;"><small class="text-muted">Lost Remarks</small><div id="modalLostRemarks" class="fw-normal text-wrap text-warning"></div></div>
              <div class="col-sm-12" id="modalReplacementDocsRow" style="display: none;">
                <small class="text-muted">Replacement Documents</small>
                <div id="modalReplacementDocs" class="mt-1"></div>
              </div>
              <div class="col-sm-6"><small class="text-muted">PO Number</small><div id="modalPONumber"></div></div>
              <div class="col-sm-6"><small class="text-muted">PO Date</small><div id="modalPODate"></div></div>
              <div class="col-sm-6"><small class="text-muted">Fund Source</small><div id="modalFundSource"></div></div>
              <div class="col-sm-6"><small class="text-muted">Supplier</small><div id="modalSupplier"></div></div>
              <div class="col-sm-6"><small class="text-muted">Project Name</small><div id="modalProjectName"></div></div>
              <div class="col-sm-6"><small class="text-muted">Assigned To</small><div id="modalAssignedTo"></div></div>
              <div class="col-sm-6"><small class="text-muted">End User</small><div id="modalEndUser"></div></div>
              <div class="col-sm-6"><small class="text-muted">Deployment Location</small><div id="modalLocation"></div></div>
              <div class="col-sm-6"><small class="text-muted">Current Location</small><div id="modalCurrentLocation"></div></div>
              <div class="col-sm-6"><small class="text-muted">Created</small><div id="modalCreated"></div></div>
              <div class="col-sm-6"><small class="text-muted">Created By</small><div id="modalCreatedBy"></div></div>
              <div class="col-sm-6"><small class="text-muted">Updated</small><div id="modalUpdated"></div></div>
              <div class="col-sm-6"><small class="text-muted">Updated By</small><div id="modalUpdatedBy"></div></div>
            </div>
            
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- History Modal -->
<div class="modal fade" id="historyModal" tabindex="-1" aria-labelledby="historyModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg"> <!-- Changed from modal-sm to modal-lg -->
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="historyModalLabel">Edit History</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="historyContent" style="max-height: 65vh; overflow-y: auto;">
        <p class="text-muted">Loading history...</p>
        <!-- You can inject table or content dynamically here -->
      </div>
    </div>
  </div>
</div>


<!-- Advanced Filter -->
<div class="modal fade" id="advancedFilterModal" tabindex="-1" aria-labelledby="advancedFilterLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="advancedFilterLabel">Advanced Filter</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="filterForm">
          <div id="filterContainer"></div>
          <button type="button" class="btn btn-sm btn-outline-secondary mt-2" id="addFilterRow">+ Add Filter</button>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" id="applyFilter" class="btn btn-primary btn-sm">Apply Filters</button>
      </div>
    </div>
  </div>
</div>

<!-- Bulk Archive Confirmation Modal -->
<div class="modal fade" id="bulkArchiveConfirmModal" tabindex="-1" aria-labelledby="bulkArchiveConfirmLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-warning text-dark">
        <h5 class="modal-title" id="bulkArchiveConfirmLabel">
          <i class="bi bi-archive me-2"></i>Confirm Bulk Archive
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="d-flex align-items-start">
          <i class="bi bi-exclamation-triangle text-warning me-3" style="font-size: 2rem;"></i>
          <div>
            <h6 class="fw-bold">Archive Selected Equipment</h6>
            <p class="mb-2">You are about to archive <span id="bulkArchiveCount" class="fw-bold text-warning">0</span> equipment(s).</p>
            <p class="text-muted small mb-0">Archived equipment will be moved to archived status and can be unarchived later if needed.</p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-warning" id="confirmBulkArchive">
          <i class="bi bi-archive me-1"></i>Archive Equipment
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Bulk Delete Confirmation Modal -->
<div class="modal fade" id="bulkDeleteConfirmModal" tabindex="-1" aria-labelledby="bulkDeleteConfirmLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-danger">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="bulkDeleteConfirmLabel">
          <i class="bi bi-exclamation-triangle me-2"></i>⚠️ DANGER: Permanent Deletion
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="d-flex align-items-start">
          <i class="bi bi-trash text-danger me-3" style="font-size: 2rem;"></i>
          <div>
            <h6 class="fw-bold text-danger">Permanently Delete Selected Equipment</h6>
            <p class="mb-2">You are about to <strong class="text-danger">PERMANENTLY DELETE</strong> <span id="bulkDeleteCount" class="fw-bold text-danger">0</span> equipment(s).</p>
            <div class="alert alert-danger py-2 px-3">
              <small class="fw-bold">⚠️ WARNING: This action CANNOT be undone!</small><br>
              <small>All equipment data, history, and associated documents will be permanently removed from the system.</small>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="confirmDeletionCheckbox">
              <label class="form-check-label text-danger fw-bold" for="confirmDeletionCheckbox">
                I understand this action is permanent and cannot be undone
              </label>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmBulkDelete" disabled>
          <i class="bi bi-trash me-1"></i>DELETE PERMANENTLY
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Bulk Update Confirmation Modal -->
<div class="modal fade" id="bulkUpdateConfirmModal" tabindex="-1" aria-labelledby="bulkUpdateConfirmLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="bulkUpdateConfirmLabel">
          <i class="bi bi-pencil-square text-warning me-2"></i>Confirm Bulk Update
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-warning d-flex align-items-center mb-3">
          <i class="bi bi-exclamation-triangle-fill me-2"></i>
          <div>
            <strong>Bulk Update Action</strong><br>
            You are about to update <strong id="bulkUpdateCount">0</strong> selected equipment items.
          </div>
        </div>
        
        <div class="mb-3">
          <strong>Changes to apply:</strong>
          <ul class="list-unstyled mt-2 mb-0">
            <li id="statusChangeInfo" class="text-muted" style="display: none;">
              <i class="bi bi-arrow-right me-1"></i>Status: <span class="fw-bold" id="newStatusName"></span>
            </li>
            <li id="categoryChangeInfo" class="text-muted" style="display: none;">
              <i class="bi bi-arrow-right me-1"></i>Category: <span class="fw-bold" id="newCategoryName"></span>
            </li>
          </ul>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-warning" id="confirmBulkUpdate">
          <i class="bi bi-pencil-square me-1"></i>UPDATE EQUIPMENT
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Individual Archive Confirmation Modal -->
<div class="modal fade" id="individualArchiveConfirmModal" tabindex="-1" aria-labelledby="individualArchiveConfirmLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-warning text-dark">
        <h5 class="modal-title" id="individualArchiveConfirmLabel">
          <i class="bi bi-archive me-2"></i>Confirm Archive
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="d-flex align-items-start">
          <i class="bi bi-exclamation-triangle text-warning me-3" style="font-size: 2rem;"></i>
          <div>
            <h6 class="fw-bold">Archive Equipment</h6>
            <p class="mb-2">Are you sure you want to archive this equipment?</p>
            <div class="bg-light p-2 rounded mb-2">
              <small class="text-muted">Equipment:</small><br>
              <span id="individualArchiveEquipmentName" class="fw-bold">Loading...</span>
            </div>
            <p class="text-muted small mb-0">This equipment will be moved to archived status and can be unarchived later if needed.</p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-warning" id="confirmIndividualArchive">
          <i class="bi bi-archive me-1"></i>Archive Equipment
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Import Error Modal -->
<div class="modal fade" id="importErrorModal" tabindex="-1" aria-labelledby="importErrorLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-danger">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="importErrorLabel">
          <i class="bi bi-exclamation-triangle-fill me-2"></i><span id="importErrorTitle">Import Failed</span>
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-danger mb-3">
          <h6 class="fw-bold mb-2"><i class="bi bi-x-circle me-1"></i><span id="importErrorMessage">Error Message</span></h6>
          <p class="mb-0" id="importErrorDetails">Error details will appear here.</p>
        </div>
        <div class="bg-light p-3 rounded">
          <h6 class="fw-bold mb-2"><i class="bi bi-lightbulb text-warning me-1"></i>How to Fix:</h6>
          <ol class="mb-0 ps-3">
            <li>Review the error message above</li>
            <li>Fix the issue in your Excel file or add missing data to the system</li>
            <li>Try importing again</li>
          </ol>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
          <i class="bi bi-check-circle me-1"></i>Understood
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Individual Delete Confirmation Modal -->
<div class="modal fade" id="individualDeleteConfirmModal" tabindex="-1" aria-labelledby="individualDeleteConfirmLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-danger">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="individualDeleteConfirmLabel">
          <i class="bi bi-exclamation-triangle me-2"></i>⚠️ DANGER: Permanent Deletion
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="d-flex align-items-start">
          <i class="bi bi-trash text-danger me-3" style="font-size: 2rem;"></i>
          <div>
            <h6 class="fw-bold text-danger">Permanently Delete Equipment</h6>
            <p class="mb-2">Are you sure you want to <strong class="text-danger">PERMANENTLY DELETE</strong> this equipment?</p>
            <div class="bg-light p-2 rounded mb-2">
              <small class="text-muted">Equipment:</small><br>
              <span id="individualDeleteEquipmentName" class="fw-bold">Loading...</span>
            </div>
            <div class="alert alert-danger py-2 px-3">
              <small class="fw-bold">⚠️ WARNING: This action CANNOT be undone!</small><br>
              <small>All equipment data, history, and associated documents will be permanently removed.</small>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="confirmIndividualDeletionCheckbox">
              <label class="form-check-label text-danger fw-bold" for="confirmIndividualDeletionCheckbox">
                I understand this action is permanent and cannot be undone
              </label>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmIndividualDelete" disabled>
          <i class="bi bi-trash me-1"></i>DELETE PERMANENTLY
        </button>
      </div>
    </div>
  </div>
</div>


<!-- Compact Table Style -->
<style>
  /* Compact table styling */
  .compact-table td,
  .compact-table th {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 160px;
  }

  .compact-table td.text-wrap,
  .compact-table th.text-wrap {
    white-space: normal;
    word-break: break-word;
  }

  /* Responsive tweaks for mobile */
  @media (max-width: 768px) {
    .compact-table td,
    .compact-table th {
      white-space: normal !important;
      word-break: break-word !important;
      max-width: none !important;
      font-size: 0.75rem;
      padding: 0.25rem 0.4rem;
    }

    .table-responsive {
      overflow-x: auto;
    }
  }

  /* Search bar and select/input sizes */
  #tableSearch {
    min-width: 250px;
    max-width: 400px;
    padding-left: 1.5rem;
    border: 1px solid #ced4da;
    transition: box-shadow 0.2s ease-in-out;
    font-size: 0.8rem;
  }

  #tableSearch:focus {
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
    border-color: #80bdff;
  }

  select.form-select-sm,
  .btn-sm {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
  }

  /* DataTables Pagination */
  .dataTables_paginate .pagination {
    font-size: 0.75rem;
    gap: 0.25rem;
  }

  .dataTables_paginate .page-link {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
  }

  .dataTables_wrapper .dataTables_paginate {
    margin-top: 0.5rem;
  }

  .dataTables_paginate .pagination .page-link {
    color: #198754;
    border: 1px solid #198754;
    border-radius: 0.375rem;
    transition: all 0.2s ease-in-out;
    padding: 0.35rem 0.65rem;
    font-weight: 500;
  }

  /* Disabled dropdown item styling */
  .dropdown-item.disabled {
    color: #adb5bd !important;
    background-color: transparent !important;
    cursor: not-allowed !important;
    pointer-events: auto !important; /* Allow tooltips to work */
  }

  .dropdown-item.disabled:hover {
    color: #adb5bd !important;
    background-color: #f8f9fa !important;
  }

  .dropdown-item.disabled .text-muted {
    color: #adb5bd !important;
  }

  /* Ensure disabled buttons can still show tooltips */
  button:disabled {
    pointer-events: auto !important;
  }

  button:disabled:hover {
    cursor: not-allowed;
  }

  .dataTables_paginate .pagination .page-link.active,
  .dataTables_paginate .pagination .active > .page-link {
    background-color: #198754;
    color: #fff;
    border-color: #198754;
    box-shadow: 0 0 0 0.1rem rgba(25, 135, 84, 0.3);
  }

  .dataTables_paginate .pagination .page-link:hover {
    background-color: #e9f5ee;
    color: #14532d;
    border-color: #14532d;
    text-decoration: none;
  }

  .dataTables_paginate .pagination .page-item.disabled .page-link {
    background-color: #f8f9fa;
    color: #adb5bd;
    border-color: #dee2e6;
  }

  /* Better responsive table styling like history_logs */
  #equipmentTable {
    white-space: nowrap;
  }

  #equipmentTable th,
  #equipmentTable td {
    padding: 0.5rem 0.25rem;
    font-size: 0.875rem;
    vertical-align: middle;
  }

  /* Text truncation for longer content */
  #equipmentTable td:nth-child(5),
  #equipmentTable td:nth-child(6),
  #equipmentTable td:nth-child(9) {
    max-width: 200px;
    text-overflow: ellipsis;
    overflow: hidden;
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    #equipmentTable th,
    #equipmentTable td {
      padding: 0.25rem 0.125rem;
      font-size: 0.8rem;
    }
    
    /* Make description/name columns more compact on mobile */
    #equipmentTable td:nth-child(5),
    #equipmentTable td:nth-child(6) {
      max-width: 120px;
    }
  }

  @media (max-width: 576px) {
    #equipmentTable th,
    #equipmentTable td {
      padding: 0.2rem 0.1rem;
      font-size: 0.75rem;
    }
    
    #equipmentTable td:nth-child(5),
    #equipmentTable td:nth-child(6) {
      max-width: 100px;
    }
  }
</style>


<!-- DataTables -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
<script>
// Check user permissions at the template level - using context variables
const canManageDocuments = {{ is_admin|yesno:"true,false" }} || {{ is_encoder|yesno:"true,false" }};

let table;
$(document).ready(function () {
  // Check for import error and show modal
  {% if import_error %}
    $('#importErrorTitle').text('{{ import_error.title }}');
    $('#importErrorMessage').text('{{ import_error.message }}');
    $('#importErrorDetails').html('{{ import_error.details|safe }}');
    
    setTimeout(function() {
      try {
        const modal = new bootstrap.Modal(document.getElementById('importErrorModal'));
        modal.show();
      } catch (e) {
        $('#importErrorModal').modal('show');
      }
    }, 500);
  {% endif %}
  
  const isClient = {{ is_client|yesno:"true,false" }};
  const columnMap = {
  2: 'Property #',
  3: 'Name',
  4: 'Description',
  5: 'PO Number',
  6: 'Fund Source',
  7: 'Supplier',
  8: 'Amount',
  9: 'Assigned To',
  10: 'End User',
  11: 'Deployment Location',
  12: 'Current Location',
  13: 'Category',
  14: 'Status',
  15: 'Purchase Date'
};

  // Success and Error Message Functions
  function showSuccessMessage(message) {
    const alertDiv = `
      <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle me-2"></i>${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    `;
    $('.container-fluid').prepend(alertDiv);
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
      $('.alert-success').fadeOut();
    }, 5000);
  }

  function showErrorMessage(message) {
    const alertDiv = `
      <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle me-2"></i>${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    `;
    $('.container-fluid').prepend(alertDiv);
    // Auto-dismiss after 8 seconds
    setTimeout(() => {
      $('.alert-danger').fadeOut();
    }, 8000);
  }

  // Init DataTable
table = $('#equipmentTable').DataTable({
  dom: 'lrtip',
  serverSide: true,
  processing: true,
  order: [[1, 'desc']],
  // stateSave: true,
  scrollX: true,
  autoWidth: false,
  
  ajax: {
    url: "{% url 'equipments:equipment_table_json' %}",
    type: 'GET',
    
    data: function (d) {
      // Gather all filters
      $('.filter-row').each(function () {
        const colIdx = $(this).find('.column-select').val();
        const value = $(this).find('.value-input').val();
        d['filter_col_' + colIdx] = value;
      });
    },
    
    error: function(xhr, error, code) {
      console.error('DataTables Ajax Error:', {
        status: xhr.status,
        error: error,
        code: code,
        response: xhr.responseText
      });
      
      // Show user-friendly error message
      const errorMsg = xhr.status === 500 ? 'Server error occurred' : `Error ${xhr.status}: ${error}`;
      $('#equipmentTable_wrapper').prepend(`
        <div class="alert alert-danger alert-dismissible" role="alert">
          <strong>Table Error:</strong> ${errorMsg}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      `);
    }
  },
  columns: [
    {
      data: null,
      orderable: false,
      render: function (data, type, row) {
        return `<input type="checkbox" class="equipment-checkbox" value="${row[1]}">`; // row[1] is the ID now
      }
    },
  { visible: false }, // ID
  { title: "Image", orderable: false },
  { title: "Property #" },
  { title: "Name" },
  { title: "Description" },
  { title: "PO Number" },
  { title: "Amount" },
  { title: "End User" },
  { title: "Category" },
  { title: "Status" },
  { title: "Actions", orderable: false, visible: !isClient },
  { title: "Fund Source", visible: false },
  { title: "Supplier", visible: false },
  { title: "Assigned To", visible: false },
  { title: "Deployment Location", visible: false },
  { title: "Current Location", visible: false },
  { title: "PO Date", visible: false },
  { title: "Project Name", visible: false }
  ],
  pageLength: 10
});

  let orderDesc = true; // Track current order

  $('#toggleOrderBtn').on('click', function () {
    if (orderDesc) {
      table.order([1, 'asc']).draw(); // Oldest first
      $(this).text('Show Newest First');
    } else {
      table.order([1, 'desc']).draw(); // Newest first
      $(this).text('Show Oldest First');
    }
    orderDesc = !orderDesc;
  });

// Column titles in order (match your DataTable columns)
const columnTitles = [
  "Select", "ID", "Image", "Property #", "Name", "Description", "PO Number", "Amount", "End User", "Category", "Status", "Actions",
  "Fund Source", "Supplier", "Assigned To", "Deployment Location", "Current Location", "PO Date", "Project Name"
];

const defaultVisible = [
  true, false, true, true, true, true, true, true, true, true, true, true,
  false, false, false, false, false, false, false
];

// Populate the dropdown
columnTitles.forEach((title, idx) => {
  // Don't show the "ID" column in the menu
  if (title === "ID") return;

    $('#columnVisibilityMenu').append(`
      <li>
        <label class="dropdown-item">
          <input type="checkbox" class="toggle-vis" data-column="${idx}" ${defaultVisible[idx] ? 'checked' : ''}>
          ${title}
        </label>
      </li>
    `);
  });

  $('#columnVisibilityMenu').on('click', function (e) {
    e.stopPropagation();
  });

    // Handle toggling
  $('#columnVisibilityMenu').on('change', '.toggle-vis', function () {
    var column = table.column($(this).data('column'));
    column.visible(this.checked, false); // false = don't redraw yet
    table.columns.adjust().draw(false);  // redraw after all changes
  });



  // Custom global search (searches all columns)
  $('#tableSearch').on('keyup', function () {
    table.search(this.value).draw();
  });

  // Add filter row
  $('#addFilterRow').click(function () {
    const idx = $('.filter-row').length;
    const selectOptions = Object.entries(columnMap).map(
      ([i, name]) => `<option value="${i}">${name}</option>`
    ).join('');

    $('#filterContainer').append(`
      <div class="row mb-2 filter-row" data-idx="${idx}">
        <div class="col-md-5">
          <select class="form-select form-select-sm column-select">${selectOptions}</select>
        </div>
        <div class="col-md-5 value-col">
          <input type="text" class="form-control form-control-sm value-input" placeholder="Enter value">
        </div>
        <div class="col-md-2 text-end">
          <button type="button" class="btn btn-sm btn-outline-danger remove-filter">&times;</button>
        </div>
      </div>
    `);
  });

$(document).on('change', '.column-select', function () {
  const colIdx = $(this).val();
  const $valueCol = $(this).closest('.filter-row').find('.value-col');
  if (colIdx == '6') {
    // Fund Source
    $valueCol.html(`<select class="form-select form-select-sm value-input">
      <option value="">All</option>
      {% for fund in fund_sources %}
        <option value="{{ fund }}">{{ fund }}</option>
      {% endfor %}
    </select>`);
  } else if (colIdx == '7') {
    // Supplier
    $valueCol.html(`<select class="form-select form-select-sm value-input">
      <option value="">All</option>
      {% for supplier in suppliers %}
        <option value="{{ supplier }}">{{ supplier }}</option>
      {% endfor %}
    </select>`);
  } else if (colIdx == '9') {
    // Assigned To
    $valueCol.html(`<select class="form-select form-select-sm value-input">
      <option value="">All</option>
      {% for assigned in assigned_to_list %}
        <option value="{{ assigned }}">{{ assigned }}</option>
      {% endfor %}
    </select>`);
  } else if (colIdx == '10') {
    // End User
    $valueCol.html(`<select class="form-select form-select-sm value-input">
      <option value="">All</option>
      {% for user in end_users %}
        <option value="{{ user }}">{{ user }}</option>
      {% endfor %}
    </select>`);
  } else if (colIdx == '11') {
    // Deployment Location
    $valueCol.html(`<select class="form-select form-select-sm value-input">
      <option value="">All</option>
      {% for loc in locations %}
        <option value="{{ loc }}">{{ loc }}</option>
      {% endfor %}
    </select>`);
  } else if (colIdx == '13') {
    // Category
    $valueCol.html(`<select class="form-select form-select-sm value-input">
      <option value="">All</option>
      {% for cat in categories %}
        <option value="{{ cat.name }}">{{ cat.name }}</option>
      {% endfor %}
    </select>`);
  } else if (colIdx == '14') {
    // Status
    $valueCol.html(`<select class="form-select form-select-sm value-input">
      <option value="">All</option>
      {% for stat in statuses %}
        <option value="{{ stat.name }}">{{ stat.name }}</option>
      {% endfor %}
    </select>`);
  } else {
    // Default to text input
    $valueCol.html('<input type="text" class="form-control form-control-sm value-input" placeholder="Enter value">');
  }
});
  // Remove filter row
  $(document).on('click', '.remove-filter', function () {
    $(this).closest('.filter-row').remove();
  });

  // Apply filters
  $('#applyFilter').click(function () {
    // 1. Gather filtered column indices
    let filteredCols = [];
    $('.filter-row').each(function () {
      const colIdx = parseInt($(this).find('.column-select').val());
      if (!isNaN(colIdx)) filteredCols.push(colIdx);
    });

    // 4. Reload data
    table.ajax.reload();
    $('#advancedFilterModal').modal('hide');
  });

  $('#equipmentTable tbody').on('click', 'tr', function (e) {
    // Prevent modal if clicking a checkbox or its cell
    if (
      $(e.target).is('input[type="checkbox"]') ||
      $(e.target).closest('button').length ||
      $(e.target).closest('a').length ||
      $(e.target).closest('td').find('input[type="checkbox"]').length ||
      $(e.target).closest('td').index() === 11 // Actions column index (adjust if needed)
    ) {
      return;
    }

    var table = $('#equipmentTable').DataTable();
    var data = table.row(this).data();
    var equipmentId = data[1]; // This is the hidden ID column, always present in the data array

    // Now fetch and show the modal as before
    $.get(`/weims/equipment/${equipmentId}/json/`, function(data) {
        $('#modalImage').attr('src', data.image);
        $('#modalPropertyNum').text(data.propertynum);
        $('#modalName').text(data.name);
        $('#modalDesc').text(data.desc);
        $('#modalAddInfo').text(data.addinfo);
        $('#modalAmount').text('₱' + data.amount);
        $('#modalCategory').text(data.category);
        $('#modalStatus').text(data.status);
        
        // Show/hide damage reason based on status
        if (data.status === 'Damaged' && data.damage_reason !== 'None') {
          $('#modalDamageReason').text(data.damage_reason);
          $('#modalDamageReasonRow').show();
        } else {
          $('#modalDamageReasonRow').hide();
        }
        
        // Show/hide lost remarks based on status
        if (data.status === 'Lost' && data.lost_remarks !== 'None') {
          $('#modalLostRemarks').text(data.lost_remarks);
          $('#modalLostRemarksRow').show();
        } else {
          $('#modalLostRemarksRow').hide();
        }
        
        // Show/hide replacement documents based on status
        if (data.status === 'Lost' && data.replacement_documents && data.replacement_documents.length > 0) {
          let docsHtml = '';
          data.replacement_documents.forEach(function(doc, index) {
            docsHtml += `
              <div class="d-flex align-items-center justify-content-between border rounded p-2 mb-1 bg-light" data-doc-id="${doc.id}">
                <div class="flex-grow-1">
                  <a href="${doc.url}" target="_blank" class="text-decoration-none">
                    <i class="bi bi-file-earmark-text me-1"></i>
                    <span class="fw-medium">${doc.filename}</span>
                  </a>
                  <br>
                  <small class="text-muted">
                    Uploaded: ${doc.uploaded_at} by ${doc.uploaded_by}
                  </small>
                </div>
                <div class="btn-group btn-group-sm" role="group">
                  <a href="${doc.url}" target="_blank" class="btn btn-outline-primary" title="View/Download">
                    <i class="bi bi-eye"></i>
                  </a>`;
            
            if (canManageDocuments) {
              docsHtml += `
                  <button type="button" class="btn btn-outline-warning replace-doc-btn" 
                          data-doc-id="${doc.id}" data-filename="${doc.filename}" title="Replace">
                    <i class="bi bi-arrow-clockwise"></i>
                  </button>
                  <button type="button" class="btn btn-outline-danger delete-doc-btn" 
                          data-doc-id="${doc.id}" data-filename="${doc.filename}" title="Delete">
                    <i class="bi bi-trash"></i>
                  </button>`;
            }
            
            docsHtml += `
                </div>
              </div>
            `;
          });
          
          // Add "Add More Documents" button for authorized users
          if (canManageDocuments) {
            docsHtml += `
              <div class="mt-2">
                <button type="button" class="btn btn-sm btn-outline-success add-more-docs-btn" 
                        data-equipment-id="${data.id}">
                  <i class="bi bi-plus-circle me-1"></i>Add More Documents
                </button>
              </div>
            `;
          }
          
          $('#modalReplacementDocs').html(docsHtml);
          $('#modalReplacementDocsRow').show();
        } else if (data.status === 'Lost') {
          // Show "Add Documents" button even if no documents exist
          if (canManageDocuments) {
            let docsHtml = `
              <div class="text-center py-2">
                <p class="text-muted mb-2">No replacement documents uploaded yet.</p>
                <button type="button" class="btn btn-sm btn-outline-success add-more-docs-btn" 
                        data-equipment-id="${data.id}">
                  <i class="bi bi-plus-circle me-1"></i>Add Documents
                </button>
              </div>
            `;
            $('#modalReplacementDocs').html(docsHtml);
            $('#modalReplacementDocsRow').show();
          } else {
            $('#modalReplacementDocsRow').hide();
          }
        } else {
          $('#modalReplacementDocsRow').hide();
        }
        
        $('#modalPONumber').text(data.po_number);
        $('#modalPODate').text(data.po_date);
        $('#modalFundSource').text(data.fund_source);
        $('#modalSupplier').text(data.supplier);
        $('#modalProjectName').text(data.project_name);
        $('#modalAssignedTo').text(data.assigned_to);
        $('#modalEndUser').text(data.end_user);
        $('#modalLocation').text(data.location);
        $('#modalCurrentLocation').text(data.current_location);
        $('#modalCreated').text(data.created);
        $('#modalCreatedBy').text(data.created_by);
        $('#modalUpdated').text(data.updated);
        $('#modalUpdatedBy').text(data.updated_by);
        $('#equipmentModal').data('equipment-id', equipmentId); // <-- Add this line
        $('#equipmentModal').modal('show');
      });
  });

  $('#selectAll').on('click', function () {
    $('.equipment-checkbox').prop('checked', this.checked);
    updateBulkActionButtons();
  });

  // Update bulk action buttons visibility based on selection
  function updateBulkActionButtons() {
    const selectedCount = $('.equipment-checkbox:checked').length;
    const bulkArchiveBtn = $('#bulkArchiveBtn');
    const bulkDeleteBtn = $('#bulkDeleteBtn');
    const bulkUpdateForm = $('#bulkUpdateForm');
    const applyBtn = bulkUpdateForm.find('button[type="submit"]');
    
    if (selectedCount > 0) {
      // Enable buttons
      bulkArchiveBtn.removeClass('btn-outline-warning').addClass('btn-warning').prop('disabled', false);
      bulkArchiveBtn.find('i').removeClass('text-muted').addClass('text-white');
      
      // Only update delete button if it exists (admin/superadmin only)
      if (bulkDeleteBtn.length > 0) {
        bulkDeleteBtn.removeClass('btn-outline-danger').addClass('btn-danger').prop('disabled', false);
        bulkDeleteBtn.find('i').removeClass('text-muted').addClass('text-white');
      }
      
      applyBtn.removeClass('btn-outline-primary').addClass('btn-primary').prop('disabled', false);
    } else {
      // Disable buttons
      bulkArchiveBtn.removeClass('btn-warning').addClass('btn-outline-warning').prop('disabled', true);
      bulkArchiveBtn.find('i').removeClass('text-white').addClass('text-muted');
      
      // Only update delete button if it exists (admin/superadmin only)
      if (bulkDeleteBtn.length > 0) {
        bulkDeleteBtn.removeClass('btn-danger').addClass('btn-outline-danger').prop('disabled', true);
        bulkDeleteBtn.find('i').removeClass('text-white').addClass('text-muted');
      }
      
      applyBtn.removeClass('btn-primary').addClass('btn-outline-primary').prop('disabled', true);
    }
  }

  // Listen for individual checkbox changes
  $(document).on('change', '.equipment-checkbox', function() {
    updateBulkActionButtons();
    
    // Update select all checkbox state
    const totalCheckboxes = $('.equipment-checkbox').length;
    const checkedCheckboxes = $('.equipment-checkbox:checked').length;
    $('#selectAll').prop('indeterminate', checkedCheckboxes > 0 && checkedCheckboxes < totalCheckboxes);
    $('#selectAll').prop('checked', checkedCheckboxes === totalCheckboxes);
  });

  // Initialize button states
  updateBulkActionButtons();
  
  $('#bulkUpdateForm').on('submit', function (e) {
    e.preventDefault();
    console.log('Bulk update form submitted'); // Debug
    
    const selectedIds = $('.equipment-checkbox:checked')
      .map((_, cb) => cb.value)
      .get();

    if (selectedIds.length === 0) {
      alert("Please select at least one equipment.");
      return;
    }

    // Get selected status and category
    const statusSelect = $('select[name="status_id"]');
    const categorySelect = $('select[name="category_id"]');
    const statusId = statusSelect.val();
    const categoryId = categorySelect.val();
    
    // Check if any changes are selected
    if (!statusId && !categoryId) {
      // Show instructional modal instead of basic alert
      console.log('No status or category selected, showing instruction modal');
      
      // Try Bootstrap 5 syntax first
      try {
        const modal = new bootstrap.Modal(document.getElementById('selectStatusCategoryModal'));
        modal.show();
      } catch (e) {
        console.log('Bootstrap 5 failed, trying jQuery/Bootstrap 4:', e);
        // Fallback to jQuery/Bootstrap 4 syntax
        $('#selectStatusCategoryModal').modal('show');
      }
      return;
    }

    // Show confirmation modal with details
    $('#bulkUpdateCount').text(selectedIds.length);
    
    // Show what changes will be applied
    if (statusId) {
      const statusName = statusSelect.find('option:selected').text();
      $('#newStatusName').text(statusName);
      $('#statusChangeInfo').show();
    } else {
      $('#statusChangeInfo').hide();
    }
    
    if (categoryId) {
      const categoryName = categorySelect.find('option:selected').text();
      $('#newCategoryName').text(categoryName);
      $('#categoryChangeInfo').show();
    } else {
      $('#categoryChangeInfo').hide();
    }
    
    console.log('About to show bulk update modal'); // Debug
    
    // Try Bootstrap 5 syntax first
    try {
      const modal = new bootstrap.Modal(document.getElementById('bulkUpdateConfirmModal'));
      modal.show();
    } catch (e) {
      console.log('Bootstrap 5 failed, trying jQuery/Bootstrap 4:', e);
      // Fallback to jQuery/Bootstrap 4 syntax
      $('#bulkUpdateConfirmModal').modal('show');
    }
    
    // Store form data for later use
    $('#bulkUpdateConfirmModal').data('selectedIds', selectedIds);
    $('#bulkUpdateConfirmModal').data('statusId', statusId);
    $('#bulkUpdateConfirmModal').data('categoryId', categoryId);
  });

  // Handle confirmed bulk update
  $('#confirmBulkUpdate').on('click', function() {
    const selectedIds = $('#bulkUpdateConfirmModal').data('selectedIds');
    const statusId = $('#bulkUpdateConfirmModal').data('statusId');
    const categoryId = $('#bulkUpdateConfirmModal').data('categoryId');
    $('#bulkUpdateConfirmModal').modal('hide');
    
    // Prepare form data
    const formData = [];
    formData.push({ name: 'csrfmiddlewaretoken', value: $('[name=csrfmiddlewaretoken]').val() });
    formData.push({ name: 'equipment_ids', value: selectedIds.join(',') });
    
    if (statusId) {
      formData.push({ name: 'status_id', value: statusId });
    }
    if (categoryId) {
      formData.push({ name: 'category_id', value: categoryId });
    }

    $.post($('#bulkUpdateForm').attr('action'), formData, function (response) {
      alert("Bulk update successful.");
      table.ajax.reload(); // Refresh table
      
      // Reset form
      $('#bulkUpdateForm')[0].reset();
      updateBulkActionButtons();
    }).fail(function (xhr) {
      // Show specific error message from server
      let errorMsg = "Something went wrong.";
      if (xhr.responseJSON && xhr.responseJSON.error) {
        errorMsg = xhr.responseJSON.error;
      }
      alert(errorMsg);
    });
  });

  // Bulk Archive functionality
  $('#bulkArchiveBtn').on('click', function () {
    console.log('Bulk archive button clicked'); // Debug
    const selectedIds = $('.equipment-checkbox:checked')
      .map((_, cb) => cb.value)
      .get();

    console.log('Selected IDs:', selectedIds); // Debug

    if (selectedIds.length === 0) {
      alert("Please select at least one equipment to archive.");
      return;
    }

    // Show custom confirmation modal
    $('#bulkArchiveCount').text(selectedIds.length);
    console.log('About to show modal'); // Debug
    
    // Try Bootstrap 5 syntax first
    try {
      const modal = new bootstrap.Modal(document.getElementById('bulkArchiveConfirmModal'));
      modal.show();
    } catch (e) {
      console.log('Bootstrap 5 failed, trying jQuery/Bootstrap 4:', e);
      // Fallback to jQuery/Bootstrap 4 syntax
      $('#bulkArchiveConfirmModal').modal('show');
    }
    
    // Store selected IDs for later use
    $('#bulkArchiveConfirmModal').data('selectedIds', selectedIds);
  });

  // Handle bulk archive confirmation
  $('#confirmBulkArchive').on('click', function() {
    const selectedIds = $('#bulkArchiveConfirmModal').data('selectedIds');
    $('#bulkArchiveConfirmModal').modal('hide');
    
    // Send bulk archive request
    $.post("{% url 'equipments:bulk_archive' %}", {
      'equipment_ids': selectedIds.join(','),
      'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
    }, function (response) {
      // Show success message
      showSuccessMessage(`Successfully archived ${selectedIds.length} equipment(s).`);
      table.ajax.reload(); // Refresh table
      $('.equipment-checkbox').prop('checked', false); // Uncheck all
      $('#selectAll').prop('checked', false); // Uncheck select all
    }).fail(function (xhr) {
      let errorMsg = "Failed to archive equipment.";
      if (xhr.responseJSON && xhr.responseJSON.error) {
        errorMsg = xhr.responseJSON.error;
      }
      showErrorMessage(errorMsg);
    });
  });

  // Bulk Delete functionality
  $('#bulkDeleteBtn').on('click', function () {
    console.log('Bulk delete button clicked'); // Debug
    const selectedIds = $('.equipment-checkbox:checked')
      .map((_, cb) => cb.value)
      .get();

    if (selectedIds.length === 0) {
      alert("Please select at least one equipment to delete.");
      return;
    }

    // Show custom confirmation modal
    $('#bulkDeleteCount').text(selectedIds.length);
    $('#confirmDeletionCheckbox').prop('checked', false);
    $('#confirmBulkDelete').prop('disabled', true);
    
    console.log('About to show delete modal'); // Debug
    
    // Try Bootstrap 5 syntax first
    try {
      const modal = new bootstrap.Modal(document.getElementById('bulkDeleteConfirmModal'));
      modal.show();
    } catch (e) {
      console.log('Bootstrap 5 failed, trying jQuery/Bootstrap 4:', e);
      // Fallback to jQuery/Bootstrap 4 syntax
      $('#bulkDeleteConfirmModal').modal('show');
    }
    
    // Store selected IDs for later use
    $('#bulkDeleteConfirmModal').data('selectedIds', selectedIds);
  });

  // Handle deletion confirmation checkbox
  $('#confirmDeletionCheckbox').on('change', function() {
    $('#confirmBulkDelete').prop('disabled', !this.checked);
  });

  // Handle bulk delete confirmation
  $('#confirmBulkDelete').on('click', function() {
    const selectedIds = $('#bulkDeleteConfirmModal').data('selectedIds');
    $('#bulkDeleteConfirmModal').modal('hide');
    
    // Send bulk delete request
    $.post("{% url 'equipments:bulk_delete' %}", {
      'equipment_ids': selectedIds.join(','),
      'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
    }, function (response) {
      showSuccessMessage(`Successfully deleted ${selectedIds.length} equipment(s) permanently.`);
      table.ajax.reload(); // Refresh table
      $('.equipment-checkbox').prop('checked', false); // Uncheck all
      $('#selectAll').prop('checked', false); // Uncheck select all
    }).fail(function (xhr) {
      let errorMsg = "Failed to delete equipment.";
      if (xhr.responseJSON && xhr.responseJSON.error) {
        errorMsg = xhr.responseJSON.error;
      }
      showErrorMessage(errorMsg);
    });
  });

  // Individual Archive Confirmation
  window.showIndividualArchiveConfirm = function(equipmentId, equipmentName, archiveUrl) {
    $('#individualArchiveEquipmentName').text(equipmentName);
    $('#individualArchiveConfirmModal').data('archiveUrl', archiveUrl);
    $('#individualArchiveConfirmModal').modal('show');
  };

  $('#confirmIndividualArchive').on('click', function() {
    const archiveUrl = $('#individualArchiveConfirmModal').data('archiveUrl');
    $('#individualArchiveConfirmModal').modal('hide');
    window.location.href = archiveUrl;
  });

  // Individual Delete Confirmation
  window.showIndividualDeleteConfirm = function(equipmentId, equipmentName, deleteUrl) {
    $('#individualDeleteEquipmentName').text(equipmentName);
    $('#confirmIndividualDeletionCheckbox').prop('checked', false);
    $('#confirmIndividualDelete').prop('disabled', true);
    $('#individualDeleteConfirmModal').data('deleteUrl', deleteUrl);
    $('#individualDeleteConfirmModal').modal('show');
  };

  // Handle individual deletion confirmation checkbox
  $('#confirmIndividualDeletionCheckbox').on('change', function() {
    $('#confirmIndividualDelete').prop('disabled', !this.checked);
  });

  $('#confirmIndividualDelete').on('click', function() {
    const deleteUrl = $('#individualDeleteConfirmModal').data('deleteUrl');
    $('#individualDeleteConfirmModal').modal('hide');
    window.location.href = deleteUrl;
  });
  

  $('#returnModal').on('show.bs.modal', function (event) {
    $('.modal').not(this).modal('hide');
    var button = $(event.relatedTarget);
    var eqId = button.data('eqid');
    var eqName = button.data('eqname');
    var eqProperty = button.data('eqproperty');
    
    // Set the equipment ID for form submission
    $('#returnEquipmentId').val(eqId);
    
    // Display equipment information
    $('#returnEquipmentName').text(eqName || 'N/A');
    $('#returnEquipmentProperty').text(eqProperty || 'N/A');
  });

  // Reset file input when modal is hidden
  $('#returnModal').on('hidden.bs.modal', function () {
    $('#returnDocument')[0].value = '';
    $('#selectedFiles').hide();
    $('#fileList').empty();
    
    // Clear equipment information
    $('#returnEquipmentName').text('N/A');
    $('#returnEquipmentProperty').text('N/A');
    $('#returnEquipmentId').val('');
  });

  // Handle file selection display for return modal
  $('#returnDocument').on('change', function() {
    updateFileList();
  });

  // Function to update file list display
  function updateFileList() {
    const files = $('#returnDocument')[0].files;
    const fileList = $('#fileList');
    const selectedFilesDiv = $('#selectedFiles');
    
    if (files.length > 0) {
      fileList.empty();
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const fileSize = (file.size / 1024 / 1024).toFixed(2); // Convert to MB
        fileList.append(`
          <li class="d-flex justify-content-between align-items-center py-2 border-bottom" data-file-index="${i}">
            <div class="d-flex align-items-center">
              <i class="bi bi-file-earmark me-2 text-primary"></i>
              <div>
                <div class="fw-medium text-dark">${file.name}</div>
                <small class="text-muted">${fileSize} MB</small>
              </div>
            </div>
            <button type="button" class="btn btn-sm btn-outline-danger remove-file-btn" data-file-index="${i}" title="Remove file">
              <i class="bi bi-x"></i>
            </button>
          </li>
        `);
      }
      selectedFilesDiv.show();
    } else {
      selectedFilesDiv.hide();
    }
  }

  // Handle file removal
  $(document).on('click', '.remove-file-btn', function() {
    const fileIndex = parseInt($(this).data('file-index'));
    const input = $('#returnDocument')[0];
    const dt = new DataTransfer();
    
    // Add all files except the one to be removed to DataTransfer object
    for (let i = 0; i < input.files.length; i++) {
      if (i !== fileIndex) {
        dt.items.add(input.files[i]);
      }
    }
    
    // Update the input files
    input.files = dt.files;
    
    // Update the display
    updateFileList();
  });

  // Handle clear all files
  $(document).on('click', '.clear-all-files', function() {
    const input = $('#returnDocument')[0];
    input.value = ''; // Clear the input
    updateFileList(); // Update the display
  });
  
    $('#historyModal').on('show.bs.modal', function () {
    const equipmentId = $('#equipmentModal').data('equipment-id'); // Store this ID when opening modal
    $('#historyContent').html('<p class="text-muted">Loading history...</p>');
    
    $.get(`/weims/${equipmentId}/history/`, function (data) {
      if (!data || data.length === 0) {
        $('#historyContent').html('<p class="text-muted">No history available.</p>');
      } else {
        // Build a table for the new structure
        let tableHtml = `
          <div class="table-responsive-sm">
            <table class="table table-sm table-bordered mb-0">
              <thead class="table-light">
                <tr>
                  <th>Date</th>
                  <th>Action</th>
                  <th>Field</th>
                  <th>Old Value</th>
                  <th>New Value</th>
                  <th>Reason</th>
                  <th>Changed By</th>
                </tr>
              </thead>
              <tbody>
        `;
        data.forEach(h => {
          tableHtml += `
            <tr>
              <td>${h.changed_at}</td>
              <td>${h.action}</td>
              <td>${h.field_changed}</td>
              <td class="text-danger">${h.old_value || 'None'}</td>
              <td class="text-success">${h.new_value || 'None'}</td>
              <td class="text-warning">${h.reason || 'N/A'}</td>
              <td>${h.changed_by}</td>
            </tr>
          `;
        });
        tableHtml += '</tbody></table></div>';
        $('#historyContent').html(tableHtml);
      }
    });
  });

  // Document management event handlers
  $(document).on('click', '.replace-doc-btn', function() {
    const docId = $(this).data('doc-id');
    const filename = $(this).data('filename');
    
    // Create file input for replacement
    const fileInput = $('<input type="file" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" style="display: none;">');
    
    fileInput.on('change', function() {
      const file = this.files[0];
      if (file) {
        if (confirm(`Replace "${filename}" with "${file.name}"?`)) {
          const formData = new FormData();
          formData.append('replacement_file', file);
          formData.append('csrfmiddlewaretoken', $('[name=csrfmiddlewaretoken]').val());
          
          $.ajax({
            url: `/weims/replacement-document/${docId}/replace/`,
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
              if (response.success) {
                alert('Document replaced successfully!');
                // Refresh the modal content
                const equipmentId = $('#equipmentModal').data('equipment-id');
                if (equipmentId) {
                  $('#equipmentTable tbody tr').each(function() {
                    const table = $('#equipmentTable').DataTable();
                    const rowData = table.row(this).data();
                    if (rowData && rowData[0] == equipmentId) {
                      $(this).click();
                      return false;
                    }
                  });
                }
              } else {
                alert('Error: ' + (response.error || 'Failed to replace document'));
              }
            },
            error: function(xhr) {
              alert('Error replacing document: ' + (xhr.responseJSON?.error || 'Server error'));
            }
          });
        }
      }
    });
    
    fileInput.click();
  });

  $(document).on('click', '.delete-doc-btn', function() {
    const docId = $(this).data('doc-id');
    const filename = $(this).data('filename');
    
    if (confirm(`Are you sure you want to delete "${filename}"? This action cannot be undone.`)) {
      $.ajax({
        url: `/weims/replacement-document/${docId}/delete/`,
        type: 'POST',
        data: {
          'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
        },
        success: function(response) {
          if (response.success) {
            alert('Document deleted successfully!');
            // Remove the document element from the modal
            $(`.border[data-doc-id="${docId}"]`).fadeOut(300, function() {
              $(this).remove();
              // Check if no documents left
              if ($('#modalReplacementDocs .border[data-doc-id]').length === 0) {
                const equipmentId = $('#equipmentModal').data('equipment-id');
                $('#modalReplacementDocs').html(`
                  <div class="text-center py-2">
                    <p class="text-muted mb-2">No replacement documents uploaded yet.</p>
                    <button type="button" class="btn btn-sm btn-outline-success add-more-docs-btn" 
                            data-equipment-id="${equipmentId}">
                      <i class="bi bi-plus-circle me-1"></i>Add Documents
                    </button>
                  </div>
                `);
              }
            });
          } else {
            alert('Error: ' + (response.error || 'Failed to delete document'));
          }
        },
        error: function(xhr) {
          alert('Error deleting document: ' + (xhr.responseJSON?.error || 'Server error'));
        }
      });
    }
  });

  $(document).on('click', '.add-more-docs-btn', function() {
    const equipmentId = $(this).data('equipment-id');
    
    // Create file input for multiple files
    const fileInput = $('<input type="file" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" multiple style="display: none;">');
    
    fileInput.on('change', function() {
      const files = Array.from(this.files);
      if (files.length > 0) {
        const fileList = files.map(f => f.name).join(', ');
        if (confirm(`Upload ${files.length} document(s): ${fileList}?`)) {
          const formData = new FormData();
          files.forEach(file => {
            formData.append('replacement_files', file);
          });
          formData.append('equipment_id', equipmentId);
          formData.append('csrfmiddlewaretoken', $('[name=csrfmiddlewaretoken]').val());
          
          $.ajax({
            url: `/weims/replacement-document/add/`,
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
              if (response.success) {
                alert(`${response.uploaded_count} document(s) uploaded successfully!`);
                // Refresh the modal content
                $('#equipmentTable tbody tr').each(function() {
                  const table = $('#equipmentTable').DataTable();
                  const rowData = table.row(this).data();
                  if (rowData && rowData[0] == equipmentId) {
                    $(this).click();
                    return false;
                  }
                });
              } else {
                alert('Error: ' + (response.error || 'Failed to upload documents'));
              }
            },
            error: function(xhr) {
              alert('Error uploading documents: ' + (xhr.responseJSON?.error || 'Server error'));
            }
          });
        }
      }
    });
    
    fileInput.click();
  });

  // Store equipment ID in modal for reference
  $('#equipmentModal').on('show.bs.modal', function() {
    const table = $('#equipmentTable').DataTable();
    const selectedRow = table.row('.selected').data();
    if (selectedRow) {
      $(this).data('equipment-id', selectedRow[0]);
    }
  });

  // Initialize tooltips for disabled buttons
  function initializeTooltips() {
    // Initialize tooltips for elements with data-bs-toggle="tooltip"
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Initialize tooltips for elements with title attribute (including disabled buttons)
    var titleElements = [].slice.call(document.querySelectorAll('button[title]:not([data-bs-toggle="tooltip"]), a[title]:not([data-bs-toggle="tooltip"])'));
    var titleTooltips = titleElements.map(function (titleElement) {
      // Dispose existing tooltip if any
      var existingTooltip = bootstrap.Tooltip.getInstance(titleElement);
      if (existingTooltip) {
        existingTooltip.dispose();
      }
      
      return new bootstrap.Tooltip(titleElement, {
        placement: 'top',
        trigger: 'hover focus' // Ensure it works on disabled buttons
      });
    });
  }

  // Initialize tooltips when page loads
  initializeTooltips();

  // Re-initialize tooltips when DataTable redraws (after pagination, search, etc.)
  table.on('draw', function() {
    initializeTooltips();
    updateBulkActionButtons(); // Update button states after table redraw
  });

});
</script>

<!-- Select Status/Category First Modal -->
<div class="modal fade" id="selectStatusCategoryModal" tabindex="-1" aria-labelledby="selectStatusCategoryModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-warning text-dark">
        <h5 class="modal-title" id="selectStatusCategoryModalLabel">
          <i class="fas fa-exclamation-triangle me-2"></i>Selection Required
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="text-center">
          <i class="fas fa-hand-pointer fa-3x text-warning mb-3"></i>
          <h6 class="mb-3">Please Select an Action First</h6>
          <p class="mb-0">Before you can update equipment, you need to:</p>
          <ul class="list-unstyled mt-2">
            <li><i class="fas fa-check text-success me-2"></i>Choose a <strong>Status</strong> to change to, OR</li>
            <li><i class="fas fa-check text-success me-2"></i>Choose a <strong>Category</strong> to change to</li>
          </ul>
          <div class="alert alert-info mt-3 mb-0">
            <small><i class="fas fa-info-circle me-1"></i>Use the dropdown menus above the equipment table to make your selection.</small>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
          <i class="fas fa-check me-1"></i>Got it!
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %}
