{% extends 'equipments/base.html' %}
{% block title %}Edit Equipment{% endblock %}
{% load static %}
{% block content %}

<div class="container py-3">
  <div class="card shadow-sm border-0 mx-auto" style="max-width: 920px;">
    <div class="card-header text-white" style="background-color: #0e4a39;">
      <h5 class="mb-0">Edit Equipment</h5>
    </div>

    <div class="card-body p-4">
      <form action="" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="row g-3">

          <!-- ðŸ–¼ Image & Property -->
          <div class="col-12 small fw-bold text-secondary border-bottom pb-1">Equipment Image & Info</div>
          <div class="col-md-6">
            <label class="form-label small">Equipment Image</label>
            <input type="file" class="form-control form-control-sm" name="user_image" id="user_image">
            {% if equipment.user_image %}
            <img src="{{ equipment.user_image.url }}" alt="Current Image" style="max-width:100px; margin-top:10px;">
            {% endif %}
          </div>
          <div class="col-md-6">
            <label class="form-label small">Property Number</label>
            <input type="text" class="form-control form-control-sm" name="item_propertynum" value="{{ equipment.item_propertynum }}">
          </div>

          <!-- ðŸ“„ Details -->
          <div class="col-12 small fw-bold text-secondary border-bottom pt-2 pb-1">Details</div>
          <div class="col-md-6">
            <label class="form-label small">Item Name</label>
            <input type="text" class="form-control form-control-sm" name="item_name" value="{{ equipment.item_name }}">
          </div>
          <div class="col-md-6">
            <label class="form-label small">Item Description</label>
            <input type="text" class="form-control form-control-sm" name="item_desc" value="{{ equipment.item_desc }}">
          </div>

          <!-- ðŸ§¾ Purchase -->
          <div class="col-12 small fw-bold text-secondary border-bottom pt-2 pb-1">Purchase Information</div>
          <div class="col-md-6">
            <label class="form-label small">Purchase Date</label>
            <input type="date" name="item_purdate" class="form-control form-control-sm" value="{{ equipment.item_purdate|date:'Y-m-d' }}">
          </div>
          <div class="col-md-6">
            <label class="form-label small">PO Number</label>
            <input type="text" class="form-control form-control-sm" name="po_number" value="{{ equipment.po_number }}">
          </div>
          <div class="col-md-6">
            <label class="form-label small">Fund Source</label>
            <input type="text" class="form-control form-control-sm" name="fund_source" value="{{ equipment.fund_source }}">
          </div>
          <div class="col-md-6">
            <label class="form-label small">Supplier</label>
            <input type="text" class="form-control form-control-sm" name="supplier" value="{{ equipment.supplier }}">
          </div>
          <div class="col-md-6">
            <label class="form-label small">Amount</label>
            <input type="number" step="0.01" class="form-control form-control-sm" name="item_amount" value="{{ equipment.item_amount }}">
          </div>
          <div class="col-md-6">
            <label class="form-label small">Order Receipt</label>
            <input type="file" class="form-control form-control-sm" name="order_receipt" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx">
            {% if equipment.order_receipt %}
            <div class="mt-2">
              <small class="text-muted">Current: <a href="{{ equipment.order_receipt.url }}" target="_blank">{{ equipment.order_receipt.name|slice:"15:" }}</a></small>
            </div>
            {% endif %}
          </div>

          <!-- ðŸ§‘â€ðŸ’¼ Assignment -->
          <div class="col-12 small fw-bold text-secondary border-bottom pt-2 pb-1">Assignment & Location</div>
          <div class="col-md-6">
            <label class="form-label small">Project Name</label>
            <select name="project_name_select" id="projectNameSelect" class="form-select form-select-sm mb-2" onchange="toggleProjectNameInput()">
              <option value="">Select project name</option>
              {% for project in existing_project_names %}
              <option value="{{ project }}" {% if equipment.project_name == project %}selected{% endif %}>{{ project }}</option>
              {% endfor %}
              <option value="other">Other (Type new)</option>
            </select>
            <input type="text" name="project_name" id="projectNameCustom" class="form-control form-control-sm" value="{% if equipment.project_name and equipment.project_name not in existing_project_names %}{{ equipment.project_name }}{% endif %}" placeholder="Type new project name" style="display: {% if equipment.project_name and equipment.project_name not in existing_project_names %}block{% else %}none{% endif %};">
          </div>
          <div class="col-md-6">
            <label class="form-label small">Assigned To</label>
            <select name="assigned_to_select" id="assignedToSelect" class="form-select form-select-sm mb-2" onchange="toggleAssignedToInput()">
              <option value="">Select assigned to</option>
              {% for assignee in existing_assigned_to %}
              <option value="{{ assignee }}" {% if equipment.assigned_to == assignee %}selected{% endif %}>{{ assignee }}</option>
              {% endfor %}
              <option value="other">Other (Type new)</option>
            </select>
            <input type="text" name="assigned_to" id="assignedToCustom" class="form-control form-control-sm" value="{% if equipment.assigned_to and equipment.assigned_to not in existing_assigned_to %}{{ equipment.assigned_to }}{% endif %}" placeholder="Type new assignee name" style="display: {% if equipment.assigned_to and equipment.assigned_to not in existing_assigned_to %}block{% else %}none{% endif %};">
            <textarea name="assignment_reason" id="assignmentReasonField" class="form-control form-control-sm mt-2" rows="2" placeholder="Reason for assignment change (optional)" style="display: none; background-color: #d4edda; border-color: #28a745;">{{ equipment.assignment_reason }}</textarea>
          </div>
          <div class="col-md-6">
            <label class="form-label small">End User</label>
            <select name="end_user_select" id="endUserSelect" class="form-select form-select-sm mb-2" onchange="toggleEndUserInput()">
              <option value="">Select end user</option>
              {% for user in existing_end_users %}
              <option value="{{ user }}" {% if equipment.end_user == user %}selected{% endif %}>{{ user }}</option>
              {% endfor %}
              <option value="other">Other (Type new)</option>
            </select>
            <input type="text" name="end_user" id="endUserCustom" class="form-control form-control-sm" value="{% if equipment.end_user and equipment.end_user not in existing_end_users %}{{ equipment.end_user }}{% endif %}" placeholder="Type new end user name" style="display: {% if equipment.end_user and equipment.end_user not in existing_end_users %}block{% else %}none{% endif %};">
            <textarea name="user_change_reason" id="userChangeReasonField" class="form-control form-control-sm mt-2" rows="2" placeholder="Reason for end user change (optional)" style="display: none; background-color: #d4edda; border-color: #28a745;">{{ equipment.user_change_reason }}</textarea>
          </div>
          <div class="col-md-6">
            <label class="form-label small">Deployment Location</label>
            <select name="location_select" id="locationSelect" class="form-select form-select-sm mb-2" onchange="toggleLocationInput()">
              <option value="">Select deployment location</option>
              {% for location in existing_locations %}
              <option value="{{ location }}" {% if equipment.location == location %}selected{% endif %}>{{ location }}</option>
              {% endfor %}
              <option value="other">Other (Type new)</option>
            </select>
            <input type="text" name="location" id="locationCustom" class="form-control form-control-sm" value="{% if equipment.location and equipment.location not in existing_locations %}{{ equipment.location }}{% endif %}" placeholder="Type new deployment location" style="display: {% if equipment.location and equipment.location not in existing_locations %}block{% else %}none{% endif %};">
            <textarea name="location_change_reason" id="locationChangeReasonField" class="form-control form-control-sm mt-2" rows="2" placeholder="Reason for location change (optional)" style="display: none; background-color: #d4edda; border-color: #28a745;">{{ equipment.location_change_reason }}</textarea>
          </div>
          <div class="col-md-6">
            <label class="form-label small">Current Location</label>
            <select name="current_location_select" id="currentLocationSelect" class="form-select form-select-sm mb-2" onchange="toggleCurrentLocationInput()">
              <option value="">Select current location</option>
              {% for location in existing_current_locations %}
              <option value="{{ location }}" {% if equipment.current_location == location %}selected{% endif %}>{{ location }}</option>
              {% endfor %}
              <option value="other">Other (Type new)</option>
            </select>
            <input type="text" name="current_location" id="currentLocationCustom" class="form-control form-control-sm" value="{% if equipment.current_location and equipment.current_location not in existing_current_locations %}{{ equipment.current_location }}{% endif %}" placeholder="Type new current location" style="display: {% if equipment.current_location and equipment.current_location not in existing_current_locations %}block{% else %}none{% endif %};">
            <textarea name="current_location_reason" id="currentLocationReasonField" class="form-control form-control-sm mt-2" rows="2" placeholder="Reason for current location change (optional)" style="display: none; background-color: #d4edda; border-color: #28a745;">{{ equipment.current_location_reason }}</textarea>
          </div>

          <!-- ðŸ“ Classification -->
          <div class="col-12 small fw-bold text-secondary border-bottom pt-2 pb-1">Classification</div>
          <div class="col-md-6">
            <label class="form-label small">Employee</label>
            <select class="form-select form-select-sm" name="emp_id">
              {% for user in users %}
              <option value="{{ user.id }}" {% if equipment.emp_id == user.id %}selected{% endif %}>{{ user.username }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label small">Category</label>
            <select class="form-select form-select-sm" name="category_id">
              {% for cat in categories %}
              <option value="{{ cat.id }}" {% if equipment.category_id == cat.id %}selected{% endif %}>{{ cat.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label small">Status</label>
            <select class="form-select form-select-sm" name="status_id" id="statusSelect">
              {% for stat in statuses %}
              <option value="{{ stat.id }}" data-status-name="{{ stat.name }}" {% if equipment.status_id == stat.id %}selected{% endif %}>{{ stat.name }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- ðŸ”§ Damage Reason (conditional field) -->
          <div class="col-12" id="damageReasonSection" style="display: none;">
            <label class="form-label small">Damage Reason</label>
            <textarea class="form-control form-control-sm" name="damage_reason" rows="3" placeholder="Please describe the reason for damage...">{{ equipment.damage_reason }}</textarea>
          </div>

          <!-- ðŸ” Lost Status Fields (conditional fields) -->
          <div id="lostSection" style="display: none;">
            <div class="col-12">
              <label class="form-label small">Lost Remarks</label>
              <textarea class="form-control form-control-sm" name="lost_remarks" rows="3" placeholder="Please describe the circumstances of loss...">{{ equipment.lost_remarks }}</textarea>
            </div>
            <div class="col-12">
              <label class="form-label small">Replacement Documents</label>
              <input type="file" class="form-control form-control-sm" name="replacement_documents" id="replacementDocuments" multiple accept=".pdf,.jpg,.jpeg,.png,.gif,.bmp,.tiff">
              <div class="form-text">Upload replacement documents (multiple files allowed). Supported formats: PDF, Images</div>
              <div id="selectedReplacementFiles" class="mt-2" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <small class="text-muted fw-medium">Selected files:</small>
                  <button type="button" class="btn btn-sm btn-outline-secondary clear-all-replacement-files" title="Clear all files">
                    <i class="bi bi-trash3"></i> Clear All
                  </button>
                </div>
                <div class="border rounded p-2" style="max-height: 200px; overflow-y: auto;">
                  <ul id="replacementFileList" class="list-unstyled mb-0"></ul>
                </div>
              </div>
            </div>
          </div>

          <!-- âœ… Buttons -->
          <div class="col-12 text-end pt-3">
            <a href="{% url 'equipments:index' %}" class="btn btn-sm btn-outline-secondary px-4">Cancel</a>
            <button type="submit" class="btn btn-sm btn-custom px-4 me-2">Save Changes</button>
          </div>

        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const statusSelect = document.getElementById('statusSelect');
  const damageReasonSection = document.getElementById('damageReasonSection');
  const damageReasonTextarea = document.querySelector('textarea[name="damage_reason"]');
  const lostSection = document.getElementById('lostSection');
  const lostRemarksTextarea = document.querySelector('textarea[name="lost_remarks"]');
  const replacementDocsInput = document.getElementById('replacementDocuments');

  // Function to update replacement file list display
  function updateReplacementFileList() {
    if (!replacementDocsInput) return;
    
    const files = replacementDocsInput.files;
    const fileList = document.getElementById('replacementFileList');
    const selectedFilesDiv = document.getElementById('selectedReplacementFiles');
    
    if (files.length > 0) {
      fileList.innerHTML = '';
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const fileSize = (file.size / 1024 / 1024).toFixed(2); // Convert to MB
        const listItem = document.createElement('li');
        listItem.className = 'd-flex justify-content-between align-items-center py-2 border-bottom';
        listItem.setAttribute('data-file-index', i);
        listItem.innerHTML = `
          <div class="d-flex align-items-center">
            <i class="bi bi-file-earmark me-2 text-primary"></i>
            <div>
              <div class="fw-medium text-dark">${file.name}</div>
              <small class="text-muted">${fileSize} MB</small>
            </div>
          </div>
          <button type="button" class="btn btn-sm btn-outline-danger remove-replacement-file-btn" data-file-index="${i}" title="Remove file">
            <i class="bi bi-x"></i>
          </button>
        `;
        fileList.appendChild(listItem);
      }
      selectedFilesDiv.style.display = 'block';
    } else {
      selectedFilesDiv.style.display = 'none';
    }
  }

  function toggleConditionalFields() {
    const selectedOption = statusSelect.options[statusSelect.selectedIndex];
    const statusName = selectedOption.getAttribute('data-status-name');
    
    // Handle Damaged status
    if (statusName === 'Damaged') {
      damageReasonSection.style.display = 'block';
      damageReasonTextarea.required = true;
    } else {
      damageReasonSection.style.display = 'none';
      damageReasonTextarea.required = false;
      // Clear the damage reason if switching away from damaged status
      if (statusName !== 'Damaged') {
        damageReasonTextarea.value = '';
      }
    }
    
    // Handle Lost status
    if (statusName === 'Lost') {
      lostSection.style.display = 'block';
      lostRemarksTextarea.required = true;
    } else {
      lostSection.style.display = 'none';
      lostRemarksTextarea.required = false;
      // Clear the lost remarks and files if switching away from lost status
      if (statusName !== 'Lost') {
        lostRemarksTextarea.value = '';
        // Clear replacement documents
        if (replacementDocsInput) {
          replacementDocsInput.value = '';
          updateReplacementFileList();
        }
      }
    }
  }

  // Check initial status on page load
  toggleConditionalFields();

  // Listen for status changes
  statusSelect.addEventListener('change', toggleConditionalFields);

  // Replacement Documents File Management
  if (replacementDocsInput) {
    replacementDocsInput.addEventListener('change', function() {
      updateReplacementFileList();
    });
  }

  // Handle replacement file removal
  document.addEventListener('click', function(e) {
    if (e.target.closest('.remove-replacement-file-btn')) {
      const fileIndex = parseInt(e.target.closest('.remove-replacement-file-btn').dataset.fileIndex);
      const input = replacementDocsInput;
      const dt = new DataTransfer();
      
      // Add all files except the one to be removed to DataTransfer object
      for (let i = 0; i < input.files.length; i++) {
        if (i !== fileIndex) {
          dt.items.add(input.files[i]);
        }
      }
      
      // Update the input files
      input.files = dt.files;
      
      // Update the display
      updateReplacementFileList();
    }
  });

  // Handle clear all replacement files
  document.addEventListener('click', function(e) {
    if (e.target.closest('.clear-all-replacement-files')) {
      if (replacementDocsInput) {
        replacementDocsInput.value = ''; // Clear the input
        updateReplacementFileList(); // Update the display
      }
    }
  });
});

// Toggle functions for each combo box
function toggleProjectNameInput() {
  toggleComboInput('projectNameSelect', 'projectNameCustom', 'project_name');
}

function toggleAssignedToInput() {
  toggleComboInput('assignedToSelect', 'assignedToCustom', 'assigned_to');
  // Show/hide assignment reason field
  const select = document.getElementById('assignedToSelect');
  const reasonField = document.getElementById('assignmentReasonField');
  if (select.value && select.value !== '') {
    reasonField.style.display = 'block';
    reasonField.value = ''; // Clear existing reason when dropdown changes
  } else {
    reasonField.style.display = 'none';
    reasonField.value = ''; // Clear the reason when hiding
  }
}

function toggleEndUserInput() {
  toggleComboInput('endUserSelect', 'endUserCustom', 'end_user');
  // Show/hide end user change reason field
  const select = document.getElementById('endUserSelect');
  const reasonField = document.getElementById('userChangeReasonField');
  if (select.value && select.value !== '') {
    reasonField.style.display = 'block';
    reasonField.value = ''; // Clear existing reason when dropdown changes
  } else {
    reasonField.style.display = 'none';
    reasonField.value = ''; // Clear the reason when hiding
  }
}

function toggleLocationInput() {
  toggleComboInput('locationSelect', 'locationCustom', 'location');
  // Show/hide location change reason field
  const select = document.getElementById('locationSelect');
  const reasonField = document.getElementById('locationChangeReasonField');
  if (select.value && select.value !== '') {
    reasonField.style.display = 'block';
    reasonField.value = ''; // Clear existing reason when dropdown changes
  } else {
    reasonField.style.display = 'none';
    reasonField.value = ''; // Clear the reason when hiding
  }
}

function toggleCurrentLocationInput() {
  toggleComboInput('currentLocationSelect', 'currentLocationCustom', 'current_location');
  // Show/hide current location change reason field
  const select = document.getElementById('currentLocationSelect');
  const reasonField = document.getElementById('currentLocationReasonField');
  if (select.value && select.value !== '') {
    reasonField.style.display = 'block';
    reasonField.value = ''; // Clear existing reason when dropdown changes
  } else {
    reasonField.style.display = 'none';
    reasonField.value = ''; // Clear the reason when hiding
  }
}

// Generic toggle function
function toggleComboInput(selectId, inputId, fieldName) {
  const select = document.getElementById(selectId);
  const customInput = document.getElementById(inputId);
  
  if (select.value === 'other') {
    customInput.style.display = 'block';
    customInput.name = fieldName;
    customInput.focus();
  } else {
    customInput.style.display = 'none';
    customInput.name = '';
    if (select.value) {
      // Create a hidden input to send the selected value
      const hiddenInput = document.createElement('input');
      hiddenInput.type = 'hidden';
      hiddenInput.name = fieldName;
      hiddenInput.value = select.value;
      select.parentNode.appendChild(hiddenInput);
    }
  }
}

// Handle form submission for all combo boxes
document.addEventListener('DOMContentLoaded', function() {
  // Initialize reason field visibility on page load - keep all reason fields hidden initially
  const fieldsToCheck = [
    { selectId: 'assignedToSelect', reasonFieldId: 'assignmentReasonField' },
    { selectId: 'endUserSelect', reasonFieldId: 'userChangeReasonField' },
    { selectId: 'locationSelect', reasonFieldId: 'locationChangeReasonField' },
    { selectId: 'currentLocationSelect', reasonFieldId: 'currentLocationReasonField' }
  ];
  
  fieldsToCheck.forEach(field => {
    const select = document.getElementById(field.selectId);
    const reasonField = document.getElementById(field.reasonFieldId);
    if (select && reasonField) {
      // Always hide reason fields on page load and clear any existing content
      reasonField.style.display = 'none';
      reasonField.value = '';
    }
  });

  const form = document.querySelector('form');
  const comboBoxes = [
    { selectId: 'projectNameSelect', inputId: 'projectNameCustom', fieldName: 'project_name' },
    { selectId: 'assignedToSelect', inputId: 'assignedToCustom', fieldName: 'assigned_to' },
    { selectId: 'endUserSelect', inputId: 'endUserCustom', fieldName: 'end_user' },
    { selectId: 'locationSelect', inputId: 'locationCustom', fieldName: 'location' },
    { selectId: 'currentLocationSelect', inputId: 'currentLocationCustom', fieldName: 'current_location' }
  ];
  
  if (form) {
    form.addEventListener('submit', function() {
      comboBoxes.forEach(combo => {
        const select = document.getElementById(combo.selectId);
        const customInput = document.getElementById(combo.inputId);
        
        if (select && customInput) {
          // Remove any existing hidden inputs for this field
          const existingHidden = document.querySelectorAll(`input[name="${combo.fieldName}"][type="hidden"]`);
          existingHidden.forEach(input => input.remove());
          
          if (select.value && select.value !== 'other') {
            // Use selected value
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = combo.fieldName;
            hiddenInput.value = select.value;
            form.appendChild(hiddenInput);
            customInput.name = '';
          } else if (select.value === 'other') {
            // Use custom input value
            customInput.name = combo.fieldName;
          }
        }
      });
    });
  }
});
</script>

{% endblock %}
