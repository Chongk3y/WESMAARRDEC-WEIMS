{% extends 'cmibase.html' %}
{% block content %}
{% load static %}
<div class="container mt-5">
    <h1 style="text-align: center; font-weight: 600; color: #008001;">Dashboard</h1>
    <hr>
    <div class="row justify-content-center mb-4">
        <div class="col-md-8">
            <div class="row">
                <div class="col-md-3 col-sm-6 col-xs-12 mb-2">
                    <a href="{% url 'CMI_View'%}" class="btn btn-primary btn-block custom-btn">
                        <div class="btn-content">
                            <h4>CMI</h4>
                            <h4>{{ cmi_count }}</h4>
                        </div>
                    </a>
                </div>
                <div class="col-md-3 col-sm-6 col-xs-12 mb-2">
                    <a href="{% url 'program_View'%}" class="btn btn-primary btn-block custom-btn">
                        <div class="btn-content">
                            <h4>Programs</h4>
                            <h4>{{ program_count }}</h4>
                        </div>
                    </a>
                </div>
                <div class="col-md-3 col-sm-6 col-xs-12 mb-2">
                    <a href="{% url 'project_view'%}" class="btn btn-primary btn-block custom-btn">
                        <div class="btn-content">
                            <h4>Projects</h4>
                            <h4>{{ project_count }}</h4>
                        </div>
                    </a>
                </div>
                <div class="col-md-3 col-sm-6 col-xs-12 mb-2">
                    <a href="{% url 'view_commodity'%}" class="btn btn-primary btn-block custom-btn">
                        <div class="btn-content">
                            <h4>Commodities</h4>
                            <h4>{{ commodity_count }}</h4>
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </div>
    <div class="row justify-content-center">
        <div class="col-md-3" style="display: flex; flex-direction: column; justify-content: space-between;">
            <h3 style="font-weight: 600; color: #008001;">Projects per Year:</h3>
            <div class="chart-container">
                <canvas id="projectsPerYearChart"></canvas>
            </div>
        </div>
        <div class="col-md-3">
            <h3 style="font-weight: 600; color: #008001;">Project Status:</h3>
            <div class="chart-container">
                <canvas id="projectStatusChart"></canvas>
            </div>
            <div id="projectCounts"></div>
        </div>
        <div class="col-md-3">
            <h3 style="font-weight: 600; color: #008001;">Program Status:</h3>
            <div class="chart-container">
                <canvas id="programStatusChart"></canvas>
            </div>
            <div id="programCounts"></div>
        </div>
        <div class="col-md-3">
            <h3 style="font-weight: 600; color: #008001;">CMI Status:</h3>
            <div class="chart-container">
                <canvas id="cmiStatusChart"></canvas>
            </div>
            <div id="cmiCounts"></div>
        </div>
    </div>
    <table class="table table-striped table-bordered">
        <thead>
            <tr>
                <th class="tableheader" colspan="3">CMI Project and Program Count</th>
            </tr>
            <tr>
                <th class="tablehead">CMI</th>
                <th class="tablehead">Projects</th>
                <th class="tablehead">Programs</th>
            </tr>
        </thead>
        <tbody>
            {% for cmi in CMIs %}
            <tr>
                <td>{{ cmi }}</td>
                <td>{{ cmi.projects.count }}</td>
                <td>{{ cmi.programs.count }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <table class="table table-striped table-bordered">
        <thead>
            <tr>
                <th class="tableheader" colspan="3">Project Leaders and Team</th>
            </tr>
            <tr>
                <th class="tablehead">Projects</th>
                <th class="tablehead">Leader</th>
                <th class="tablehead">Team</th>
            </tr>
        </thead>
        <tbody>
            {% for project in projects %}
            <tr>
                <td>{{ project }}</td>
                <td>{{ project.proj_leader }}</td>
                <td>
                    {% if project.proj_team %}
                        {% for member in project.proj_team.all %}
                            {{ member }}{% if not forloop.last %}, {% endif %}
                        {% endfor %}
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <table class="table table-striped table-bordered">
        <thead>
            <tr>
                <th class="tableheader" colspan="3">Program Leaders and Commodities</th>
            </tr>
            <tr>
                <th class="tablehead">Program</th>
                <th class="tablehead">Leader</th>
                <th class="tablehead">Commodities</th>
            </tr>
        </thead>
        <tbody>
            {% for program in programs %}
            <tr>
                <td>{{ program }}</td>
                <td>{{ program.program_leader }}</td>
                <td>
                    {% if program.commodity %}
                        {% for commodity in program.commodity.all %}
                            {{ commodity }}{% if not forloop.last %}, {% endif %}
                        {% endfor %}
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
<style>
    .tablehead {
        background-color: #43b14b !important;
        color: white !important;
    }
    .tableheader {
        background-color: #008001 !important;
        color: white !important;
    }
    .custom-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100px;
        font-size: 18px;
        padding: 10px;
        text-align: center;
        background-color: #43b14b;
        border: #43b14b;
    }
    .custom-btn:hover, .custom-btn:active, .custom-btn.active {
        background-color: #008001;
        border: #008001;
    }
    .btn-content h4 {
        margin: 0;
    }

    /* Responsive styles */
    @media (min-width: 1024px) {
        .custom-btn {
            height: 100px;
            font-size: 18px;
        }
    }
    @media (min-width: 768px) and (max-width: 1023px) {
        .custom-btn {
            height: 80px;
            font-size: 16px;
        }
    }
    @media (min-width: 425px) and (max-width: 767px) {
        .custom-btn {
            height: 60px;
            font-size: 14px;
        }
    }
    @media (max-width: 424px) {
        .custom-btn {
            height: 50px;
            font-size: 12px;
        }
    }
    .chart-container {
        position: relative;
        width: 100%;
        height: 200px; /* Adjust height as needed */
        margin-bottom: 20px; /* Add spacing between charts */
    }
    #chartContainer {
        width: 100%;
        height: 200px; /* Adjust the height as needed */
        margin: 0 auto; /* Center the chart container */
        position: relative; /* Ensure the chart container maintains its space */
    }
    #projectStatusChart, #programStatusChart, #cmiStatusChart {
        width: 100% !important; /* Ensure canvas uses full width of container */
        height: 100% !important; /* Ensure canvas uses full height of container */
    }
</style>
<script>
    async function getProjectStatusData() {
        const response = await fetch('/api/project-status-count/');
        const data = await response.json();
        return data;
    }

    async function createProjectStatusChart() {
        const data = await getProjectStatusData();
        const ctx = document.getElementById('projectStatusChart').getContext('2d');

        const completedCount = data.completed;
        const ongoingCount = data.ongoing;

        document.getElementById('projectCounts').innerHTML = `
            <p>Completed Projects: ${completedCount}</p>
            <p>Ongoing Projects: ${ongoingCount}</p>
        `;

        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['Completed', 'Ongoing'],
                datasets: [{
                    label: 'Project Status',
                    data: [completedCount, ongoingCount],
                    backgroundColor: ['#008001', '#43b14b'],
                }]
            },
            options: {
                maintainAspectRatio: false,
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(tooltipItem) {
                                const value = tooltipItem.raw;
                                const total = tooltipItem.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = (value / total * 100).toFixed(2);
                                return `${value} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    createProjectStatusChart();

    async function getProgramStatusData() {
        const response = await fetch('/api/program-status-count/');
        const data = await response.json();
        return data;
    }

    async function createProgramStatusChart() {
        const data = await getProgramStatusData();
        const ctx = document.getElementById('programStatusChart').getContext('2d');

        const completedCount = data.completed;
        const ongoingCount = data.ongoing;

        document.getElementById('programCounts').innerHTML = `
            <p>Completed Programs: ${completedCount}</p>
            <p>Ongoing Programs: ${ongoingCount}</p>
        `;

        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['Completed', 'Ongoing'],
                datasets: [{
                    label: 'Program Status',
                    data: [completedCount, ongoingCount],
                    backgroundColor: ['#008001', '#43b14b'],
                }]
            },
            options: {
                maintainAspectRatio: false,
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(tooltipItem) {
                                const value = tooltipItem.raw;
                                const total = tooltipItem.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = (value / total * 100).toFixed(2);
                                return `${value} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    createProgramStatusChart();
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    async function getProjectsPerYearData() {
        try {
            const response = await fetch('/api/projects-per-year/');
            if (!response.ok) {
                throw new Error('Failed to fetch data');
            }
            const data = await response.json();
            return data;
        } catch (error) {
            console.error('Error fetching data:', error);
            return {};
        }
    }

    async function createProjectsPerYearChart() {
        try {
            const data = await getProjectsPerYearData();
            const ctx = document.getElementById('projectsPerYearChart').getContext('2d');

            const years = Object.keys(data);
            const projectCounts = Object.values(data);

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: years.map(year => String(year)), // Ensure year is treated as a string for labels
                    datasets: [{
                        label: 'Projects per Year',
                        data: projectCounts,
                        backgroundColor: '#43b14b',
                        borderColor: '#43b14b',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Year'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Number of Projects'
                            },
                            beginAtZero: true
                        }
                    }
                }
            });
        } catch (error) {
            console.error('Error creating chart:', error);
        }
    }

    // Call the function to create the chart
    createProjectsPerYearChart();
</script>
<script>
    async function getCmiStatusData() {
        const response = await fetch('/api/cmi-status-count/');
        const data = await response.json();
        return data;
    }

    async function createCmiStatusChart() {
        const data = await getCmiStatusData();
        const ctx = document.getElementById('cmiStatusChart').getContext('2d');

        const activeCount = data.Active || 0;
        const inactiveCount = data.Inactive || 0;

        document.getElementById('cmiCounts').innerHTML = `
            <p>Active CMIs: ${activeCount}</p>
            <p>Inactive CMIs: ${inactiveCount}</p>
        `;

        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['Active', 'Inactive'],
                datasets: [{
                    label: 'CMI Status',
                    data: [activeCount, inactiveCount],
                    backgroundColor: ['#43b14b', '#8c92ac'],
                }]
            },
            options: {
                maintainAspectRatio: false,
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(tooltipItem) {
                                const value = tooltipItem.raw;
                                const total = tooltipItem.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = (value / total * 100).toFixed(2);
                                return `${value} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    createCmiStatusChart();
</script>
{% endblock %}
